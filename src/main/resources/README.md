# 基于Flink的粮油市场价格分析系统 —— 后端开发说明

## 一、项目简介

本项目旨在为粮油市场提供一个集商品交易、论坛互动、价格趋势分析与预测于一体的综合性平台。系统分为普通用户和管理员两类角色，支持商品浏览、下单、评论、点赞、收藏、公告查看、价格趋势与预测等功能。管理员可进行用户、商户、商品、公告、订单、数据分析等后台管理操作。后端采用Spring Boot开发，结合MyBatis、MySQL实现数据持久化，Flink用于实时与批处理数据分析。

## 二、系统架构说明

- **分层结构**：采用Controller-Service-Mapper-Entity分层，接口与实现分离，便于维护与扩展。
- **接口规范**：所有接口均为POST，参数通过JSON传递，返回结构统一，便于前后端对接。
- **权限分离**：普通用户与后台管理接口分离，管理操作集中在Admin*Controller。
- **数据分析**：Flink用于订单、价格等数据的实时/批处理分析，支撑数据大屏与价格预测。

## 三、数据库设计

主要表结构如下：
- 用户表（user）：存储用户基本信息。
- 商户表（merchant）：存储商户信息。
- 商品表（product）：商品信息，含商户关联。
- 订单表（order）：用户下单记录。
- 评论表（comment）、点赞表（like）、收藏表（favorite）：互动数据。
- 公告表（announcement）：系统公告，含置顶字段is_top。
- 价格历史表（price_history）：商品价格历史数据。

设计原则：
- 重要字段唯一性约束（如用户名、商品名+类型+商户等）。
- 适当索引优化查询效率。
- 外键关联保证数据一致性。

## 四、环境依赖与部署说明

- JDK 1.8 及以上
- Maven 3.6+
- MySQL 5.7/8.0
- Flink 1.14+（用于数据分析模块）
- Spring Boot 2.5+
- JWT依赖：jjwt 0.9.1

### 配置说明
- 数据库连接、MyBatis等配置见`application.properties`。
- Mapper XML文件位于`src/main/resources/mapper/xml/`。

### 启动方式
1. 配置好数据库及相关依赖。
2. 执行`mvn clean package`打包。
3. 运行`java -jar target/grainOilSystem-*.jar`启动后端服务。

## 五、接口规范与示例

- 所有接口均为POST，参数JSON格式，返回结构如下：
  ```json
  {
    "code": 0,
    "msg": "操作成功",
    "data": { ... }
  }
  ```
- 主要接口包括：
  - 用户注册/登录/信息管理
  - 商品、商户、公告、订单管理
  - 评论、点赞、收藏
  - 数据大屏与价格分析
- 管理端接口统一以`/api/admin/`开头，前台接口以`/api/`开头。
- **前后台登录接口隔离**：
  - 普通用户登录：`/api/user/login`，仅允许role=user用户登录。
  - 管理员登录：`/api/admin/login`，仅允许role=admin用户登录。
  - 登录成功后返回token，前端需在后续请求header中携带`Authorization: Bearer <token>`。

## 六、功能模块说明

1. **用户模块**：注册、登录、信息修改、注销，后台支持用户管理（增删改查、重置密码、分页筛选）。
2. **商品模块**：商品列表、详情、上下架、增删改查，新增时同商户下name+type唯一校验。
3. **商户模块**：商户信息管理，支持分页、筛选。
4. **公告模块**：公告列表、详情、置顶、增删改查，置顶公告优先显示。
5. **订单模块**：订单列表、详情、删除，支持按用户/商品/商户/时间筛选。
6. **互动模块**：评论、点赞、收藏，支持增删查，点赞/收藏同一用户同一商品只允许一次。
7. **数据分析模块**：累计/今日成交量、成交额，趋势统计，商品销量排行，价格趋势与预测。

## 七、登录态校验与接口权限拦截（安全设计）

- **JWT登录态校验**：
  - 用户/管理员登录成功后，后端生成JWT token，前端存储并在后续请求中携带。
  - 后端所有`/api/**`接口均需校验token，只有`/api/user/login`、`/api/admin/login`、`/api/user/register`放行。
  - 拦截器统一校验token有效性，token过期或伪造直接返回未登录。
- **接口权限拦截**：
  - `/api/admin/**`接口仅允许role=admin访问，普通用户访问直接返回无权限。
  - 其余接口只要token合法即可访问。
  - 拦截器自动将userId、role等信息注入request，Controller可直接获取。
- **返回结构统一**：所有拦截器返回均为Result.error结构，便于前端统一处理。

## 八、数据分析与Flink集成

- Flink用于订单、价格等数据的实时与批处理分析。
- 价格预测采用线性回归外推，支持未来N天预测。
- 数据大屏接口提供成交量、成交额、销量排行等统计数据。
- Flink作业可独立部署，结果通过接口与后端交互。

## 九、常见问题与实现细节

- **唯一性校验**：如用户名、商品名+类型+商户，数据库层加唯一索引，接口层校验并返回详细错误信息。
- **动态SQL**：MyBatis XML中大量使用动态SQL，支持多条件筛选、分页等。
- **分页筛选**：所有列表接口均支持分页与多条件筛选，参数灵活。
- **接口安全**：管理端接口需鉴权，普通用户接口与后台接口分离。
- **登录态与权限拦截**：详见第七部分。

## 十、后续扩展与论文写作建议

- 可扩展更多数据分析与可视化功能。
- 支持更多预测算法与数据源。
- README 可作为论文“系统实现”章节素材，建议结合E-R图、系统架构图进一步完善。

## 十一、致谢与参考资料

- Spring Boot、MyBatis、Flink、JWT 官方文档
- 相关开源项目与技术社区

---

如有问题或建议，欢迎联系项目开发者。 